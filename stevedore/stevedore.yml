---
- name: Base build
  hosts: all
  become: true
  tasks:
    - name: Add Microsoft GPG apt key
      apt_key:
        url: https://packages.microsoft.com/keys/microsoft.asc
        state: present

    - name: Add Powershell repository
      apt_repository:
        repo: deb https://packages.microsoft.com/ubuntu/22.04/prod jammy main
        state: present

    - name: Install base packages
      apt:
        pkg:
          - nohang
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - software-properties-common
          - dirmngr
          - python3-pip
          - virtualenv
          - python3-setuptools
          - build-essential
          - procps
          - file
          - git
          - powershell
        state: latest
        update_cache: true
        autoclean: true

    - name: Enable ssh service
      service:
        name: ssh
        enabled: true
        state: started

    - name: Install Powershell modules
      shell:
        cmd: pwsh -c "Install-Module -Force -Scope CurrentUser -AcceptLicense posh-git, Metadata, Configuration, poke, Pester, Microsoft.PowerShell.UnixTabCompletion"
        creates: /home/{{ ansible_user }}/.local/share/powershell/Modules/posh-git/

    - name: Test for Starship
      shell: which starship
      register: starship
      ignore_errors: yes
      changed_when: false

    - name: Install Starship
      shell: curl -fsLS starship.rs/install.sh | sh -s -- -y
      when: starship.rc != 0

    - name: Test for Chezmoi
      shell: which chezmoi
      register: chezmoi
      ignore_errors: yes
      changed_when: false

    - name: Install Chezmoi
      shell: curl -fsLS get.chezmoi.io | sh -s -- -b /usr/local/bin
      when: chezmoi.rc != 0
      register: chezmoi_install

    - name: Init chezmoi
      shell: chezmoi init fsackur/dotfiles --branch chezmoi --ssh --recurse-submodules=false --apply --verbose
      become: false
      when: ansible_user == "freddie" and chezmoi_install.changed
